services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      # --- KEY ---
      # Tells Docker to build *only* the 'base' stage
      # (which has node_modules) and stop.
      # The 'production' stage (with 'npm run build') is skipped.
      target: base
    container_name: domnor-backend-dev
    ports:
      - "4000:4000"
    volumes:
      # Mount local code for hot-reloading
      - ./backend:/app
      # Anonymous volume prevents local node_modules from
      # overwriting the container's node_modules.
      - /app/node_modules
    # --- KEY ---
    # Override the Dockerfile's 'CMD' to run the dev server
    command: npm run dev:docker
    env_file:
      - ./backend/.env
    depends_on:
      db:
        condition: service_healthy
    networks:
      - domnor-net

  frontend:
    build:
      context: ./frontend/domnor
      dockerfile: Dockerfile
      target: deps
    container_name: domnor-frontend-dev
    ports:
      - "3000:3000"
    environment:
      - TURBOPACK_WATCH_POLLING=true
    volumes:
      - ./frontend/domnor:/app
      - /app/node_modules
    command: npm run dev:docker
    networks:
      - domnor-net
    depends_on:
      - backend
